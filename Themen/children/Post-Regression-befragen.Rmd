
name: teil2
class: center, middle, inverse


```{r Post-Regression-befragen-1}
library("latex2exp")
library("patchwork")
library("gt")
library("rethinking")
library("tidyverse")
```

# Die Post-Verteilung befragen

---

## Post-Verteilung 1: Mittelwerte von $\alpha$ und $\beta$

.pull-left[
```{r Post-Regression-befragen-2, echo = TRUE}
post_m43a <-
  extract.samples(m43a)
```


```{r Post-Regression-befragen-3}
post_m43a %>% 
  head(n=3) %>% 
  gt() %>% 
  fmt_number(columns = everything(), decimals = 1)
```

```{r Post-Regression-befragen-4, echo = TRUE}
post_m43a_summary <-
  post_m43a %>% 
  summarise(
    a_mean = mean(a),
    b_mean = mean(b),
    s_mean = mean(sigma))
```
```{r Post-Regression-befragen-5}
post_m43a_summary %>% 
  gt() %>% 
  fmt_number(everything(), decimals = 1)
```



]

.pull-right[

```{r Post-Regression-befragen-6, echo = TRUE}
d2 %>% 
  ggplot() +
  aes(x = weight_c, y = height) +
  geom_point() +
  geom_abline(
    slope = 0.9,
    intercept = 154,
    color = "blue")
```

]

---


## Zentrale Statistiken zu den Parametern

In diesem Modell gibt es drei Parameter: $\mu, \beta, \sigma$.

.pull-left[
### Mittelwerte
- Mittlere Gr√∂√üe?
- Sch√§tzwert f√ºr den Zusammenhang von Gewicht und Gr√∂√üe?
- Sch√§tzwert f√ºr Ungewissheit in der Sch√§tzung der Gr√∂√üe?

```{r Post-Regression-befragen-7, echo = TRUE}
post_m43a_summary
```

]

.pull-right[
### Streuungen
- Wie unsicher sind wir uns in den Sch√§tzungen der Parameter?
```{r Post-Regression-befragen-8, echo = TRUE}
post_m43a_summary2 <-
  post_m43a %>% 
  summarise(
    a_sd = sd(a),
    b_sd = sd(b),
    s_sd = sd(sigma))
```


```{r Post-Regression-befragen-9}
post_m43a_summary2 %>% 
  slice_head(n=3) %>% 
  gt() %>% 
  fmt_number(everything(),
             decimals = 2)
```


]


---


## Post-Verteilung 2: Ungewissheit von $\alpha$ und $\beta$


.pull-left[
Die ersten 10 Stichproben
```{r Post-Regression-befragen-10, echo = TRUE}
d2 %>% 
  ggplot(aes(x = weight_c, y = height)) +
  geom_point() +
  geom_abline(data = post_m43a %>% slice_head(n=10),
              aes(slope = b,
                  intercept = a),
              alpha = .3)
```


]




.pull-right[
Die ersten 100 Stichproben
```{r Post-Regression-befragen-11, echo = TRUE}
d2 %>% 
  ggplot(aes(x = weight_c, y = height)) +
  geom_point() +
  geom_abline(data = post_m43a %>% slice_head(n=100),
              aes(slope = b,
                  intercept = a),
              alpha = .05)
```


]


---

## Fragen zum Achsenabschnitt (mittlere Gr√∂√üe)

.pull-left[
- Welche mittlere Gr√∂√üe mit zu 50%, 90% Wskt. nicht √ºberschritten?
- Welche mittlere Gr√∂√üe mit zu 95% Wskt. nicht unterschritten?
- Von wo bis wo reicht der innere 50%-Sch√§tzbereich der mittleren Gr√∂√üe?
- Wie wahrscheinlich ist es, dass die mittlere Gr√∂√üe bei 155 cm oder mehr liegt?


```{r quantile-post, echo = FALSE, eval = TRUE}
post_m43a %>% 
  summarise(
    q_50 = 
      quantile(a, prob = .5),
    q_90 = 
      quantile(a, prob = .9),
    q_05 = 
      quantile(a, prob = .05))

post_m43a %>% 
  summarise(          
    pi_50 = 
    quantile(a, 
             prob = c(.25, .75)))

post_m43a %>% 
  count(a >= 155)
```

]

.pull-right[
```{r Post-Regression-befragen-12, ref.label = "quantile-post", eval = FALSE, echo = TRUE}

```

]



---

## Ungewissheit von Achsenabschnitt und Steigung 

... als Histogramme visualisiert

.pull-left[

```{r Post-Regression-befragen-13, echo = TRUE, eval = TRUE}
post_m43a %>% 
  ggplot(aes(x = a)) +
  geom_density()
```

]

.pull-right[

```{r Post-Regression-befragen-14, echo = TRUE}
post_m43a %>% 
  ggplot(aes(x = b)) +
  geom_density()
```

]



---

## Ungewissheit f√ºr $\mu|\text{weight}=45, 50$

.pull-left[

```{r mu-at-50, echo = TRUE}
mu_at_45_50 <-
  post_m43a %>% 
  mutate(mu_at_45 = a,
         mu_at_50 = a + b * 5)
# 50kg ist 5 kg √ºber dem MW
# b ist zentriert: b=0 ist MW von weight
```


```{r Post-Regression-befragen-15, echo = TRUE, eval = FALSE}
mu_at_45_50 %>% 
  ggplot(aes(x = mu_at_45)) +
  geom_density()
```


```{r Post-Regression-befragen-16, echo = TRUE, eval = FALSE}
mu_at_45_50 %>% 
  ggplot(aes(x = mu_at_50)) +
  geom_density()
```


]

.pull-right[

```{r Post-Regression-befragen-17}
mu_at_45_50 %>% 
  ggplot(aes(x = mu_at_45)) +
  geom_density() +
  scale_y_continuous(NULL, breaks = NULL) +
  xlab(expression(mu["height | weight = 45"])) 
```


```{r Post-Regression-befragen-18}
mu_at_45_50 %>% 
  ggplot(aes(x = mu_at_50)) +
  geom_density() +
  scale_y_continuous(NULL, breaks = NULL) +
  xlab(expression(mu["height | weight = 50"])) 
```



]


---

## Wie gro√ü ist ein !Kung mit 50kg Gewicht im Mittel?

```{r Post-Regression-befragen-19, echo = TRUE}
mu_at_45_50 %>% 
  summarise(pi = quantile(mu_at_50, prob = c(0.5, .9)))
```
Die mittlere Gr√∂√üe liegt mit 90% Wahrscheinlichkeit zwischen den beiden Werten.


Welche mittlere Gr√∂√üe wird mit 95% Wahrscheinlichkeit nicht √ºberschritten, wenn die Person 45kg wiegt?

```{r Post-Regression-befragen-20}
mu_at_45_50 %>% 
  summarise(q_95 = quantile(mu_at_45, prob = .95))
```

---



## Posteriori-Verteilungen f√ºr alle Gr√∂√üen

Die Funktion `link()` erstellt eine Posteriori-Verteilung f√ºr jeden Wert des Pr√§diktors (`weight`), im Standard werden 1000 Stichproben aus der Posteriori-Verteilung gezogen (f√ºr jede Beobachtung im Datensatz `d2`).

.pull-left[
```{r Post-Regression-befragen-21, echo = TRUE}
weight_seq <- 
  seq(-20,20, by = 1)
mu <- link(m43a, 
  data = tibble(
    weight_c=weight_seq)) %>% 
  as_tibble()

dim(mu)  # 1000 Zeilen, 41 Spalten
```


```{r Post-Regression-befragen-22, out.width="45%"}
knitr::include_graphics("https://github.com/sebastiansauer/QM2-Folien/raw/main/img/link.png")
```
]

.pull-right[
Auszug aus `mu`:
```{r Post-Regression-befragen-23}
mu %>% 
  select(1:7) %>% 
  slice_head(n = 5) %>% 
  gt() %>% 
  fmt_number(everything(), decimals = 0)
```

In den *Zeilen* stehen die (1000) Stichproben aus der Posteriori-Verteilung; in den *Spalten* die (41) verschiedenen Gewichtswerte. In den Zellen steht jeweils die mittere gesch√§tzte Gr√∂√üe.

]

---

## !Kung-Gr√∂√üen mit Sch√§tzbereich f√ºr $\mu$

.pull-left[
```{r mu-tidy, echo = TRUE}
mu_tidy <- 
  mu %>% 
  map_dfr(PI) %>% 
  mutate(
    weight_c = weight_seq,
    mu = 155 + 0.9*weight_c)
```

```{r Post-Regression-befragen-24}
mu_tidy %>% 
  slice_head(n = 5) %>% 
  gt() %>%   
  fmt_number(everything(),
             decimals = 0)
```

`PI()` berechnet im Default Intervalle mit 89%-Breite (die Zahl gefiel dem Autor der Funktion. ü§∑)
]

.pull-right[
```{r mu-all-plot, echo=TRUE, eval = TRUE, results="hide"}
d2 %>% 
  ggplot(aes(x = weight_c)) +
  geom_point(aes(
    y = height),
    alpha = .5) +
  geom_smooth(data = mu_tidy,
              aes(y = mu,
                  ymin = `5%`, 
                  ymax = `94%`),
              stat = "identity",
              color = "blue")
```

]

---

## K√∂rpergr√∂√üen simulieren: PPV

- Die Posteriori-Verteilung (`m43_post`) gibt uns Stichproben f√ºr die Parameter, d.i. $\alpha, \sigma,\beta$ des Modells, z.B. Zeile 1:

```{r Post-Regression-befragen-25}
post_m43a %>% 
  mutate(id = 1:nrow(.), .before = 1) %>% 
  slice_head(n = 1) %>% 
  gt() %>% 
  fmt_number(everything(), decimals = 0)
```

- Auf dieser Basis k√∂nnen wir $h_i \sim \mathcal{N}(\mu_i=\alpha, \sigma)$ sch√§tzen, also eine tats√§chliche Gr√∂√üe:

```{r Post-Regression-befragen-26, echo = TRUE}
h_1 <- rnorm(n = 1, mean = 155, sd = 5)
h_1
```

- Das wiederholen wir oft (z.B. $10^4$ Mal).

- Voil√†: Unsere Posteriori-Pr√§diktiv-Verteilung (PPV).


---

## PPV plotten


.pull-left[
```{r Post-Regression-befragen-27, echo = TRUE}
set.seed(42)
ppv <-
  tibble(
    ppv = rnorm(
      n = 1e4, 
      mean = post_m43a$a, 
      sd = post_m43a$sigma))
```

```{r ppv-regr, echo = TRUE, eval = FALSE}
ppv %>% 
  ggplot(aes(x = ppv)) +
  geom_density()
```


]

.pull-right[

```{r Post-Regression-befragen-28, ref.label="ppv-regr", eval = TRUE}

```

]

---

## Fragen an die PPV

.pull-left[
- Wie gro√ü sind die !Kung im Schnitt?
- Welche Gr√∂√üe wird von 90% der Personen nicht √ºberschritten?
- Wie gro√ü sind die 10% kleinsten?

```{r Post-Regression-befragen-29, echo = TRUE }
ppv %>% 
  summarise(
    q_50 = quantile(
      ppv, prob = .5),
    height_mean = mean(ppv),
    q_90 = quantile(
      ppv, prob = .9),
    q_10 = quantile(
      ppv, prob = .1)
  )
```

]

.pull-right[
- Was ist der 50% Bereich der K√∂rpergr√∂√üe?

```{r Post-Regression-befragen-30, echo = TRUE}
ppv %>% 
  summarise(
    pi_50 = quantile(
      ppv, 
      prob = c(.25, .75))
  )
```

]





---

## Vorhersage-Intervall

Simulieren wir die tats√§chlichen Gr√∂√üen bedingt auf ein bestimmtes K√∂rpergewicht:


```{r Post-Regression-befragen-31}
post_m43a %>% 
  mutate(id = 1:nrow(.), .before = 1) %>% 
  slice_head(n = 1) %>% 
  gt() %>% 
  fmt_number(everything(), decimals = 0)
```



- Auf dieser Basis k√∂nnen wir $h_i \sim \mathcal{N}(\mu_i=\alpha +\beta \cdot \text{weight}_i, \sigma)$ sch√§tzen, also eine tats√§chliche Gr√∂√üe, bedingt auf ein Gewicht, sagen wir 55 kg (10kg √ºber dem Mittelwert):

```{r Post-Regression-befragen-32, echo = TRUE}
h_1_55kg <- rnorm(n = 1, mean = 155 + 0.9*10, sd = 5)
h_1_55kg
```

- Das wiederholen wir oft (z.B. $10^4$ Mal) f√ºr jeden Gewichtswert, der uns interessiert.

- Voil√†: Unsere PPV bedingt auf die Gewichtswerte.

- Mit `sim()` k√∂nnen wir uns diese Arbeit abnehmen lassen.


---


## Bedingte PPV visualisiert, 1

`sim()` berechnen eine PPV bedingt auf Gewichtswerte 

.pull-left[
```{r sim-height, echo = TRUE}
sim_height <- sim(
  m43a,
  data = tibble(
    weight_c = weight_seq)
  ) %>% 
  as_tibble()

dim(sim_height)
```


]

.pull-right[
```{r Post-Regression-befragen-33}
sim_height %>% 
  slice_head(n=5) %>% 
  select(1:5) %>% 
  gt() %>% 
  fmt_number(everything(), decimals = 0)
```

Die Tabelle sieht aus wie die vorherige, $\mu$, aber sie enth√§lt simulierte Gr√∂√üenwerte, keine $\mu$-Werte.

]


---

## Bedingte PPV visualisiert, 2

.pull-left[
```{r Post-Regression-befragen-34, echo = TRUE}
sim_height_tidy <-
  sim_height %>% 
  map_dfr(PI) %>% 
  mutate(
    weight_c = weight_seq,
    mu = 155 + 0.9*weight_c)
```

```{r Post-Regression-befragen-35}
sim_height_tidy %>% 
  slice_head(n=5) %>% 
  gt() %>% 
  fmt_number(everything(), decimals = 0)
```

]

.pull-right[

```{r sim-all-plot, echo=TRUE, eval = TRUE, results="hide"}
d2 %>% 
  ggplot(aes(x = weight_c)) +
  geom_point(aes(
    y = height),
    alpha = .5) +
  geom_smooth(data = sim_height_tidy,
              aes(y = mu,
                  ymin = `5%`, 
                  ymax = `94%`),
              stat = "identity",
              color = "blue")
```

]


---










